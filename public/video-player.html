<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TypeMaster - Video</title>
  <style>
    :root {
      --bg: #f0f9ff;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --accent: #0ea5e9;
      --border: #bae6fd;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #e0f2fe, #fdf2f8, #ecfdf5);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 50px rgba(14, 116, 144, 0.12);
    }
    .title {
      font-size: 13px;
      letter-spacing: 0.16em;
      font-weight: 800;
      text-transform: uppercase;
      color: #0369a1;
      margin: 0 0 10px;
    }
    .player {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: #000;
    }
    .player iframe,
    .player video {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }
    .toolbar {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .badge {
      background: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
    }
    .btn {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn:hover { border-color: #7dd3fc; }
    .error {
      margin-top: 12px;
      color: #b91c1c;
      font-size: 14px;
      font-weight: 600;
    }
    .link {
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="title">Player da Aula</p>
      <div id="playerBox" class="player"></div>

      <div class="toolbar">
        <span id="speedLabel" class="badge">Velocidade: --</span>
        <button class="btn" data-rate="0.75">0.75x</button>
        <button class="btn" data-rate="1">1x</button>
        <button class="btn" data-rate="1.25">1.25x</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="srcInfo" class="link"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const src = (params.get("src") || "").trim();
    const desiredSpeedRaw = Number.parseFloat(params.get("speed") || "0.8");
    const desiredSpeed = Number.isFinite(desiredSpeedRaw) && desiredSpeedRaw > 0 ? desiredSpeedRaw : 0.8;

    const playerBox = document.getElementById("playerBox");
    const speedLabel = document.getElementById("speedLabel");
    const errorEl = document.getElementById("error");
    const srcInfoEl = document.getElementById("srcInfo");
    srcInfoEl.textContent = src ? `Fonte: ${src}` : "";

    let ytPlayer = null;
    let htmlVideo = null;
    let currentRate = 1;

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.style.display = "block";
    }

    function setSpeedLabel(rate) {
      currentRate = rate;
      speedLabel.textContent = `Velocidade: ${rate}x`;
    }

    function parseUrlMaybe(raw) {
      try {
        return new URL(raw);
      } catch {
        return null;
      }
    }

    function extractYouTubeId(urlObj) {
      if (!urlObj) return null;
      const host = urlObj.hostname.toLowerCase();
      const path = urlObj.pathname;

      if (host.includes("youtu.be")) {
        const id = path.replace(/^\/+/, "").split("/")[0];
        return id || null;
      }

      if (!host.includes("youtube.com")) return null;
      if (path === "/watch") return urlObj.searchParams.get("v");
      if (path.startsWith("/embed/")) return path.split("/")[2] || null;
      if (path.startsWith("/shorts/")) return path.split("/")[2] || null;
      return null;
    }

    function nearestRate(target, rates) {
      if (!rates || !rates.length) return target;
      let best = rates[0];
      let dist = Math.abs(best - target);
      for (const r of rates) {
        const d = Math.abs(r - target);
        if (d < dist) {
          best = r;
          dist = d;
        }
      }
      return best;
    }

    function applyRate(rate) {
      if (ytPlayer && typeof ytPlayer.setPlaybackRate === "function") {
        const rates = typeof ytPlayer.getAvailablePlaybackRates === "function"
          ? ytPlayer.getAvailablePlaybackRates()
          : [];
        const chosen = nearestRate(rate, rates);
        ytPlayer.setPlaybackRate(chosen);
        setSpeedLabel(chosen);
        return;
      }
      if (htmlVideo) {
        htmlVideo.playbackRate = rate;
        setSpeedLabel(rate);
      }
    }

    function mountYouTube(videoId) {
      const holder = document.createElement("div");
      holder.id = "ytPlayer";
      playerBox.appendChild(holder);

      window.onYouTubeIframeAPIReady = () => {
        ytPlayer = new window.YT.Player("ytPlayer", {
          videoId,
          playerVars: {
            playsinline: 1,
            rel: 0,
            modestbranding: 1
          },
          events: {
            onReady: () => {
              applyRate(desiredSpeed);
            }
          }
        });
      };

      const script = document.createElement("script");
      script.src = "https://www.youtube.com/iframe_api";
      script.async = true;
      document.head.appendChild(script);
    }

    function isLikelyDirectVideo(urlObj) {
      if (!urlObj) return false;
      const p = urlObj.pathname.toLowerCase();
      return [".mp4", ".webm", ".ogg", ".mov"].some((ext) => p.endsWith(ext));
    }

    function mountHtmlVideo(videoUrl) {
      htmlVideo = document.createElement("video");
      htmlVideo.src = videoUrl;
      htmlVideo.controls = true;
      htmlVideo.playsInline = true;
      htmlVideo.onloadedmetadata = () => applyRate(desiredSpeed);
      playerBox.appendChild(htmlVideo);
      setSpeedLabel(desiredSpeed);
    }

    function boot() {
      if (!src) {
        showError("Link vazio. Volta ao app e adiciona um URL.");
        return;
      }

      const parsed = parseUrlMaybe(src);
      if (!parsed) {
        showError("URL invalido.");
        return;
      }

      const ytId = extractYouTubeId(parsed);
      if (ytId) {
        mountYouTube(ytId);
        return;
      }

      if (isLikelyDirectVideo(parsed)) {
        mountHtmlVideo(parsed.toString());
        return;
      }

      window.location.href = parsed.toString();
    }

    document.querySelectorAll("[data-rate]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const rate = Number.parseFloat(btn.getAttribute("data-rate"));
        if (Number.isFinite(rate) && rate > 0) applyRate(rate);
      });
    });

    boot();
  </script>
</body>
</html>
